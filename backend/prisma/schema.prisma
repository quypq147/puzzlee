// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enum dựa trên USER-DEFINED types trong SQL [cite: 4, 8, 12]
enum UserRole {
  USER
  ADMIN
}

enum EventRole {
  PARTICIPANT
  MODERATOR
  HOST
}

enum QuestionStatus {
  VISIBLE
  HIDDEN
  ANSWERED
}

enum QuestionType {
  QA
  POLL
  QUIZ
}

// 1. Bảng Profiles (Người dùng) [cite: 8]
model Profile {
  id            String    @id @default(uuid()) @db.Uuid
  username      String
  fullName      String?   @map("full_name")
  avatarUrl     String?   @map("avatar_url")
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Quan hệ
  eventsCreated Event[]   @relation("CreatedEvents")
  questions     Question[]
  answers       Answer[]
  votes         QuestionVote[]
  memberships   EventMember[]
  notifications Notification[]
  
  @@map("profiles")
}

// 2. Bảng Events (Sự kiện/Lớp học) [cite: 5]
model Event {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  description String?
  code        String?   @unique
  createdBy   String    @map("created_by") @db.Uuid
  isActive    Boolean   @default(true) @map("is_active")
  startTime   DateTime? @map("start_time")
  endTime     DateTime? @map("end_time")
  settings    Json?     @default("{\"privacy\": \"public\", \"anonymous\": true, \"moderation\": false}")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Quan hệ
  creator     Profile   @relation("CreatedEvents", fields: [createdBy], references: [id])
  members     EventMember[]
  questions   Question[]

  @@map("events")
}

// 3. Bảng Event Members (Thành viên tham gia) [cite: 4]
model EventMember {
  eventId   String    @map("event_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  role      EventRole @default(PARTICIPANT)
  joinedAt  DateTime  @default(now()) @map("joined_at")

  event     Event     @relation(fields: [eventId], references: [id])
  user      Profile   @relation(fields: [userId], references: [id])

  @@id([eventId, userId])
  @@map("event_members")
}

// 4. Bảng Questions (Câu hỏi) [cite: 12]
model Question {
  id          String         @id @default(uuid()) @db.Uuid
  eventId     String         @map("event_id") @db.Uuid
  authorId    String?        @map("author_id") @db.Uuid
  content     String
  isAnonymous Boolean        @default(false) @map("is_anonymous")
  status      QuestionStatus @default(VISIBLE)
  isPinned    Boolean        @default(false) @map("is_pinned")
  isAnswered  Boolean        @default(false) @map("is_answered")
  score       Int            @default(0)
  type        QuestionType   @default(QA) // [cite: 12]
  createdAt   DateTime       @default(now()) @map("created_at")

  event       Event          @relation(fields: [eventId], references: [id])
  author      Profile?       @relation(fields: [authorId], references: [id])
  votes       QuestionVote[]
  answers     Answer[]

  @@map("questions")
}

// 5. Bảng Question Votes (Bình chọn) [cite: 11]
model QuestionVote {
  questionId String   @map("question_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  value      Int      // 1 hoặc -1
  createdAt  DateTime @default(now()) @map("created_at")

  question   Question @relation(fields: [questionId], references: [id])
  user       Profile  @relation(fields: [userId], references: [id])

  @@id([questionId, userId])
  @@map("question_votes")
}

// 6. Bảng Answers (Câu trả lời) [cite: 3]
model Answer {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  authorId   String?  @map("author_id") @db.Uuid
  content    String
  createdAt  DateTime @default(now()) @map("created_at")

  question   Question @relation(fields: [questionId], references: [id])
  author     Profile? @relation(fields: [authorId], references: [id])

  @@map("answers")
}

// 7. Bảng Notifications [cite: 6]
model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user      Profile  @relation(fields: [userId], references: [id])

  @@map("notifications")
}
