generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---
enum UserRole {
  USER
  ADMIN
}

enum EventRole {
  PARTICIPANT
  MODERATOR
  HOST
}

enum QuestionStatus {
  VISIBLE
  HIDDEN
  ANSWERED
}

enum QuestionType {
  QA
  POLL
  QUIZ
}

// --- MODELS ---

// 1. User: Thay thế cho auth.users của Supabase [MỚI]
// Bạn cần bảng này để lưu email/password vì không còn dùng Supabase Auth
model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique
  passwordHash  String    @map("password_hash") // Lưu mật khẩu đã mã hóa (bcrypt/argon2)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Quan hệ 1-1 với Profile
  profile       Profile?

  @@map("users")
}

// 2. Profile: Thông tin hiển thị người dùng [Cập nhật]
model Profile {
  id            String    @id @db.Uuid // Khóa ngoại trỏ tới User.id
  username      String    @unique
  fullName      String?   @map("full_name")
  avatarUrl     String?   @map("avatar_url")
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Quan hệ
  user          User      @relation(fields: [id], references: [id], onDelete: Cascade)
  
  eventsCreated     Event[]         @relation("CreatedEvents")
  questions         Question[]
  answers           Answer[]
  questionVotes     QuestionVote[]
  eventMemberships  EventMember[]
  notifications     Notification[]
  pollResponses     PollResponse[]     // [MỚI]
  questionResponses QuestionResponse[] // [MỚI]

  @@map("profiles")
}

// 3. Event: Sự kiện/Lớp học
model Event {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  description String?
  code        String?   @unique
  createdBy   String    @map("created_by") @db.Uuid
  isActive    Boolean   @default(true) @map("is_active")
  startTime   DateTime? @map("start_time")
  endTime     DateTime? @map("end_time")
  settings    Json?     @default("{\"privacy\": \"public\", \"anonymous\": true, \"moderation\": false}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @default(now()) @updatedAt @map("updated_at")

  creator     Profile       @relation("CreatedEvents", fields: [createdBy], references: [id])
  members     EventMember[]
  questions   Question[]

  @@map("events")
}

// 4. EventMember: Thành viên tham gia
model EventMember {
  eventId   String    @map("event_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  role      EventRole @default(PARTICIPANT)
  joinedAt  DateTime  @default(now()) @map("joined_at")

  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      Profile   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([eventId, userId])
  @@map("event_members")
}

// 5. Question: Câu hỏi
model Question {
  id          String         @id @default(uuid()) @db.Uuid
  eventId     String         @map("event_id") @db.Uuid
  authorId    String?        @map("author_id") @db.Uuid
  content     String
  isAnonymous Boolean        @default(false) @map("is_anonymous")
  status      QuestionStatus @default(VISIBLE)
  isPinned    Boolean        @default(false) @map("is_pinned")
  isAnswered  Boolean        @default(false) @map("is_answered")
  score       Int            @default(0)
  type        QuestionType   @default(QA)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @default(now()) @updatedAt @map("updated_at")

  event             Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author            Profile?           @relation(fields: [authorId], references: [id])
  votes             QuestionVote[]
  answers           Answer[]
  options           QuestionOption[]   // [MỚI]
  pollResponses     PollResponse[]     // [MỚI]
  questionResponses QuestionResponse[] // [MỚI]

  @@map("questions")
}

// 6. QuestionOption: Các lựa chọn cho Poll/Quiz [MỚI]
model QuestionOption {
  id                String             @id @default(uuid()) @db.Uuid
  questionId        String             @map("question_id") @db.Uuid
  content           String
  isCorrect         Boolean            @default(false) @map("is_correct")
  orderIndex        Int                @default(0) @map("order_index")
  createdAt         DateTime           @default(now()) @map("created_at")

  question          Question           @relation(fields: [questionId], references: [id], onDelete: Cascade)
  pollResponses     PollResponse[]
  questionResponses QuestionResponse[]

  @@map("question_options")
}

// 7. QuestionVote: Bình chọn câu hỏi (Upvote)
model QuestionVote {
  questionId String   @map("question_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  value      Int
  createdAt  DateTime @default(now()) @map("created_at")

  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([questionId, userId])
  @@map("question_votes")
}

// 8. Answer: Câu trả lời dạng text (cho QA)
model Answer {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  authorId   String?  @map("author_id") @db.Uuid
  content    String
  createdAt  DateTime @default(now()) @map("created_at")

  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  author     Profile? @relation(fields: [authorId], references: [id])

  @@map("answers")
}

// 9. PollResponse: Câu trả lời cho Poll [MỚI]
model PollResponse {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  optionId   String   @map("option_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  question   Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  option     QuestionOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user       Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("poll_responses")
}

// 10. QuestionResponse: Câu trả lời cho Quiz (Trắc nghiệm) [MỚI]
model QuestionResponse {
  id         String   @id @default(uuid()) @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  optionId   String   @map("option_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  question   Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)
  option     QuestionOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@map("question_responses")
}

// 11. Notification
model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  type      String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}


